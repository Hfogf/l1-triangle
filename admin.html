<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin Dashboard ‚Äî L1-TRIANGLE</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .admin-page{padding:2rem 0;min-height:100vh}.admin-login-section{max-width:500px;margin:3rem auto;background:linear-gradient(135deg,var(--bg-card) 0%,rgba(139,92,246,.05) 100%);border:1px solid var(--border-color);border-radius:12px;padding:2rem}.admin-login-section h2{margin-bottom:1rem;color:var(--text-primary)}.admin-login-section input{width:100%;padding:.9rem;background:var(--bg-card-light);border:1px solid var(--border-subtle);color:var(--text-primary);border-radius:8px;margin-bottom:1rem;font-size:1rem;transition:all .3s ease}.admin-login-section input:focus{outline:0;border-color:var(--accent-orange);box-shadow:0 0 12px rgba(255,107,61,.2)}.admin-login-section button{width:100%}.admin-error{color:#e74c3c;text-align:center;margin-top:1rem;font-size:.95rem}.admin-hidden{display:none!important}.admin-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin-bottom:2rem}.stat-card{background:linear-gradient(135deg,var(--bg-card) 0%,rgba(139,92,246,.05) 100%);border:1px solid var(--border-color);border-radius:12px;padding:1.5rem;text-align:center}.stat-value{font-size:2rem;font-weight:700;color:var(--accent-orange);margin-bottom:.5rem}.stat-label{color:var(--text-secondary);font-size:.9rem}.admin-form-panel{background:linear-gradient(135deg,var(--bg-card) 0%,rgba(139,92,246,.05) 100%);border:1px solid var(--border-color);border-radius:12px;padding:2rem;margin-bottom:2rem}.admin-form-panel h3{font-size:1.5rem;margin-bottom:1rem;color:var(--text-primary)}.form-group{display:flex;flex-direction:column;gap:.5rem;margin-bottom:1rem}.form-group label{color:var(--text-secondary);font-size:.95rem;font-weight:600}.form-group input,.form-group textarea,.form-group select{padding:.9rem;background:var(--bg-card-light);border:1px solid var(--border-subtle);color:var(--text-primary);border-radius:8px;font-size:.95rem;font-family:inherit;transition:all .3s ease}.form-group input:focus,.form-group textarea:focus,.form-group select:focus{outline:0;border-color:var(--accent-orange);box-shadow:0 0 12px rgba(255,107,61,.2);background:rgba(255,107,61,.05)}.form-group textarea{resize:vertical;min-height:80px}.form-tabs{display:flex;gap:.5rem;margin-bottom:1rem;border-bottom:1px solid var(--border-subtle);padding-bottom:1rem}.form-tabs button{flex:1;padding:.75rem;background:0;border:0;color:var(--text-secondary);cursor:pointer;border-bottom:3px solid transparent;transition:all .3s ease;font-weight:600}.form-tabs button.active{color:var(--accent-orange);border-bottom-color:var(--accent-orange)}.tab-content{display:none}.tab-content.active{display:block}.image-preview{width:120px;height:120px;background:var(--bg-card-light);border:2px dashed var(--border-color);border-radius:8px;display:flex;align-items:center;justify-content:center;overflow:hidden;margin-top:.5rem}.image-preview img{width:100%;height:100%;object-fit:cover}.image-preview.empty{color:var(--text-muted);font-size:.85rem;text-align:center}.file-input-wrapper{position:relative;cursor:pointer}.file-input-wrapper input[type=file]{display:none}.file-input-label{display:block;padding:.75rem;background:var(--bg-card-light);border:2px dashed var(--border-color);border-radius:8px;cursor:pointer;transition:all .3s ease;color:var(--text-secondary);font-size:.9rem;font-weight:600;text-align:center}.file-input-wrapper:hover .file-input-label{border-color:var(--accent-orange);color:var(--accent-orange)}.shop-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1.5rem}.product-item{background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:12px;overflow:hidden;transition:all .3s ease;display:flex;flex-direction:column}.product-item:hover{border-color:var(--accent-orange);box-shadow:0 8px 24px rgba(255,107,61,.15);transform:translateY(-4px)}.product-item-image{width:100%;height:200px;background:var(--bg-card-light);overflow:hidden;position:relative}.product-item-image img{width:100%;height:100%;object-fit:cover;transition:transform .3s ease}.product-item:hover .product-item-image img{transform:scale(1.05)}.product-item-badge{position:absolute;top:.75rem;right:.75rem;background:var(--accent-orange);color:#fff;padding:.4rem .8rem;border-radius:6px;font-size:.75rem;font-weight:700}.product-item-badge.alt{background:var(--accent-purple)}.product-item-content{padding:1rem;flex:1;display:flex;flex-direction:column;gap:.5rem}.product-item-title{font-weight:700;font-size:.95rem;color:var(--text-primary);line-height:1.3}.product-item-category{font-size:.8rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:.5px}.product-item-meta{font-size:.85rem;color:var(--text-secondary)}.product-item-footer{display:flex;justify-content:space-between;align-items:center;margin-top:auto}.product-item-price{font-size:1.1rem;font-weight:700;color:var(--accent-orange)}.product-item-actions button{padding:.5rem .75rem;font-size:.8rem}.orders-list{display:grid;gap:1rem}.order-card{background:var(--bg-card-light);border:1px solid var(--border-subtle);border-radius:8px;padding:1rem}.order-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem;border-bottom:1px solid var(--border-subtle);padding-bottom:.75rem}.order-id{font-weight:700;color:var(--accent-orange)}.order-status{padding:.4rem .8rem;border-radius:6px;font-size:.85rem;font-weight:600;text-transform:uppercase}.order-status.pending{background:rgba(255,193,7,.2);color:#ffc107}.order-status.completed{background:rgba(37,211,102,.2);color:#25d366}.order-status.cancelled{background:rgba(231,76,60,.2);color:#e74c3c}.order-details{font-size:.9rem;color:var(--text-secondary);margin-bottom:.75rem;line-height:1.5}.order-items{background:rgba(255,107,61,.08);border-left:3px solid var(--accent-orange);padding:.75rem;border-radius:4px;margin-bottom:.75rem;font-size:.9rem}.order-actions{display:flex;gap:.5rem}.order-actions button{flex:1;padding:.6rem;font-size:.85rem}.btn-primary{background:linear-gradient(135deg,var(--accent-orange),var(--accent-orange-dark));color:#fff;padding:.9rem 1.5rem;border:0;border-radius:8px;font-weight:700;cursor:pointer;transition:all .3s ease;font-size:.95rem}.btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(255,107,61,.3)}.btn-danger{background:rgba(231,76,60,.1);color:#e74c3c;padding:.6rem 1rem;border:1px solid #e74c3c;border-radius:6px;font-weight:600;cursor:pointer;transition:all .3s ease;font-size:.85rem}.btn-danger:hover{background:rgba(231,76,60,.2)}.btn-success{background:rgba(37,211,102,.1);color:#25d366;padding:.6rem 1rem;border:1px solid #25d366;border-radius:6px;font-weight:600;cursor:pointer;transition:all .3s ease;font-size:.85rem}.btn-success:hover{background:rgba(37,211,102,.2)}.btn-ghost{background:0;color:var(--accent-orange);padding:.6rem 1rem;border:1px solid var(--border-subtle);border-radius:6px;font-weight:600;cursor:pointer;transition:all .3s ease;font-size:.85rem}.btn-ghost:hover{border-color:var(--accent-orange);background:rgba(255,107,61,.05)}.notification{position:fixed;top:20px;right:20px;padding:1rem 1.5rem;border-radius:8px;font-weight:700;z-index:10000;box-shadow:0 8px 24px rgba(0,0,0,.3);animation:slideIn .3s ease}.notification.success{background:#25d366;color:#fff}.notification.error{background:#e74c3c;color:#fff}.notification.info{background:var(--accent-orange);color:#fff}.notification.out{animation:slideOut .3s ease}@keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}@keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(400px);opacity:0}}
  </style>
</head>
<body>
  <header class="main-header">
    <div class="container">
      <div class="header-content">
        <div class="logo-section"><span class="logo-text">L1-<span class="logo-orange">TRIANGLE</span></span></div>
        <nav class="main-nav"><a href="index.html" class="nav-link">‚Üê Retour au site</a></nav>
        <div class="header-right"><span class="nav-link active">üõ°Ô∏è Admin Dashboard</span></div>
      </div>
    </div>
  </header>
  <main class="admin-page">
    <div class="container">
      <div class="admin-login-section" id="login-section">
        <h2>üîê Acc√®s S√©curis√©</h2>
        <p style="color:var(--text-secondary);margin-bottom:1.5rem">Entrez le code d'acc√®s</p>
        <input type="password" id="admin-code" placeholder="Code d'acc√®s">
        <button id="admin-login-btn" class="btn-primary">D√©verrouiller</button>
        <p class="admin-error" id="admin-error"></p>
      </div>
      <div id="dashboard-content" class="admin-hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;flex-wrap:wrap;gap:1rem">
          <div><h1 style="font-size:2rem;margin:0">Admin Dashboard</h1><p style="color:var(--text-secondary);margin:.25rem 0 0 0">G√©rez vos produits</p></div>
          <div style="display:flex;gap:1rem;flex-wrap:wrap">
            <a href="index.html" class="btn-ghost" style="text-decoration:none;display:inline-block">‚Üê Retour au Shop</a>
            <button id="toggle-form" class="btn-primary">+ Ajouter Produit</button>
          </div>
        </div>
        <div class="admin-stats">
          <div class="stat-card"><div class="stat-value" id="stat-products">0</div><div class="stat-label">Produits</div></div>
          <div class="stat-card"><div class="stat-value" id="stat-orders">0</div><div class="stat-label">Commandes</div></div>
          <div class="stat-card"><div class="stat-value" id="stat-pending">0</div><div class="stat-label">En attente</div></div>
        </div>
        <div class="admin-form-panel admin-hidden" id="form-panel">
          <h3>üì¶ Ajouter Produit</h3>
          <div class="form-tabs">
            <button type="button" class="tab-btn active img-tab" data-tab="url-tab">üìé URL</button>
            <button type="button" class="tab-btn img-tab" data-tab="upload-tab">üì∏ Upload</button>
          </div>
          <form id="product-form">
            <div class="form-group"><label>Titre *</label><input type="text" name="title" required></div>
            <div class="form-group"><label>Description *</label><textarea name="desc" required></textarea></div>
            <div class="form-group"><label>Cat√©gorie *</label><select name="category" required><option value="">Choisir</option><option value="accessoires">Accessoires</option><option value="moniteurs">Moniteurs</option><option value="manettes">Manettes</option><option value="consoles">Consoles</option><option value="kit-vape">Kit Vape</option><option value="autres">Autres</option></select></div>
            <div class="form-group"><label>Prix (HTG) *</label><input type="number" name="price" step="0.01" min="0" required></div>
            <div class="form-group">
              <label>Image *</label>
              <div id="url-tab" class="tab-content active">
                <input type="url" id="image-url" placeholder="https://..." required>
                <div class="image-preview empty" id="url-preview">Aper√ßu</div>
              </div>
              <div id="upload-tab" class="tab-content">
                <div class="file-input-wrapper">
                  <label class="file-input-label" for="image-file">Choisir une image (JPG/PNG)</label>
                  <input type="file" id="image-file" accept="image/*">
                </div>
                <div class="image-preview empty" id="upload-preview">Aper√ßu</div>
              </div>
            </div>
            <button type="submit" class="btn-primary">‚ú® Ajouter</button>
          </form>
        </div>
        <div style="margin-bottom:3rem"><h2 style="margin-bottom:1.5rem">üì¶ Produits</h2><div class="shop-grid" id="products-grid"><p style="grid-column:1/-1;text-align:center;color:var(--text-muted);padding:3rem">Aucun produit</p></div></div>
        <div style="background:var(--bg-card);border:1px solid var(--border-color);border-radius:12px;padding:2rem;overflow:hidden">
          <h3 style="font-size:1.5rem;margin-bottom:1rem;color:var(--text-primary)">üì´ Commandes</h3>
          <div class="orders-list" id="orders-list"><p style="text-align:center;color:var(--text-muted);padding:2rem">Aucune commande</p></div>
        </div>
      </div>
    </div>
  </main>
  <script src="js/api.js"></script>
  <script>
    // Utilise l'API unifi√©e (Supabase + fallback localStorage)
    async function getProducts(){ return await window.api.getProducts(); }
    async function createProduct(product){ return await window.api.createProduct(product); }
    async function deleteProduct(id){ return await window.api.deleteProduct(id); }
    async function getOrders(){ return await window.api.getOrders(); }
    async function updateOrder(id, updates){ return await window.api.updateOrder(id, updates); }

    // Code Admin
    const ACCESS_CODE='L1_TRIANGLE';
    let products=[],orders=[],uploadedImage=null;
    const loginSection=document.getElementById('login-section'),dashboardContent=document.getElementById('dashboard-content'),codeInput=document.getElementById('admin-code'),loginBtn=document.getElementById('admin-login-btn'),errorEl=document.getElementById('admin-error'),productForm=document.getElementById('product-form'),imageUrlInput=document.getElementById('image-url'),toggleFormBtn=document.getElementById('toggle-form'),formPanel=document.getElementById('form-panel'),productsGrid=document.getElementById('products-grid');

    function showNotification(m,t='info'){const n=document.createElement('div');n.className=`notification ${t}`;n.textContent=m;document.body.appendChild(n);setTimeout(()=>{n.classList.add('out');setTimeout(()=>n.remove(),300)},3000)}

    function unlock(){loginSection.classList.add('admin-hidden');dashboardContent.classList.remove('admin-hidden');loadProducts();loadOrders();updateStats()}

    function checkAccess(){sessionStorage.getItem('l1_admin_access')===ACCESS_CODE&&unlock()}

    loginBtn.addEventListener('click',()=>{if(codeInput.value.trim()===ACCESS_CODE){sessionStorage.setItem('l1_admin_access',ACCESS_CODE);unlock()}else{errorEl.textContent='‚ùå Code incorrect'}});

    codeInput.addEventListener('keydown',e=>e.key==='Enter'&&loginBtn.click());

    toggleFormBtn.addEventListener('click',()=>{formPanel.classList.toggle('admin-hidden');formPanel.classList.contains('admin-hidden')||formPanel.scrollIntoView({behavior:'smooth'})});

    // Tabs image (URL vs Upload)
    document.querySelectorAll('.img-tab').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.img-tab').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const target=btn.getAttribute('data-tab');
        document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.toggle('active',tc.id===target));
        // Toggle required on URL input
        imageUrlInput.required = (target==='url-tab');
      });
    });

    // Aper√ßu via URL
    imageUrlInput.addEventListener('input',e=>{const u=e.target.value.trim(),p=document.getElementById('url-preview');if(!u){p.classList.add('empty');p.innerHTML='Aper√ßu';uploadedImage=null;return}const i=new Image();i.onload=()=>{p.innerHTML=`<img src="${u}" alt="p">`;p.classList.remove('empty');uploadedImage=u};i.onerror=()=>{p.classList.add('empty');p.innerHTML='‚ö†Ô∏è Erreur'};i.src=u});

    // Aper√ßu via Upload (DataURL)
    const imageFileInput=document.getElementById('image-file');
    imageFileInput.addEventListener('change',()=>{
      const file=imageFileInput.files && imageFileInput.files[0];
      const prev=document.getElementById('upload-preview');
      if(!file){prev.classList.add('empty');prev.textContent='Aper√ßu';uploadedImage=null;return}
      if(!file.type.startsWith('image/')){prev.classList.add('empty');prev.textContent='‚ö†Ô∏è Fichier non support√©';uploadedImage=null;return}
      const reader=new FileReader();
      reader.onload=()=>{uploadedImage=reader.result;prev.classList.remove('empty');prev.innerHTML=`<img src="${uploadedImage}" alt="upload">`;};
      reader.onerror=()=>{prev.classList.add('empty');prev.textContent='‚ö†Ô∏è Erreur de lecture'};
      reader.readAsDataURL(file);
    });

    productForm.addEventListener('submit',async e=>{e.preventDefault();if(!uploadedImage){showNotification('‚ùå Image requise','error');return}try{const fd=new FormData(productForm),p={name:fd.get('title'),title:fd.get('title'),description:fd.get('desc'),category:fd.get('category'),price:Number(fd.get('price'))||0,image:uploadedImage};if(!p.name||!p.description||!p.category){showNotification('‚ùå Remplissez tous les champs','error');return}if(p.price<=0){showNotification('‚ùå Prix > 0','error');return}console.log('‚ûï Ajout produit:', p);const created=await createProduct(p);console.log('‚úÖ Cr√©√©:', created);localStorage.clear();sessionStorage.clear();showNotification('‚úÖ Rechargement...','success');setTimeout(()=>window.location.href=window.location.href+'?t='+Date.now(),500)}catch(err){console.error('‚ùå Erreur:',err);showNotification('‚ùå '+err.message,'error')}});

    async function loadProducts(){try{products=await getProducts();console.log('üì¶ Produits charg√©s dans admin:',products.length);renderProducts();updateStats()}catch(err){console.error('‚ùå Erreur loadProducts:',err);showNotification('‚ùå '+err.message,'error')}}

    function renderProducts(){productsGrid.innerHTML='';console.log('üé® Rendu de',products.length,'produits');if(!products.length){productsGrid.innerHTML='<p style="grid-column:1/-1;text-align:center;color:var(--text-muted);padding:3rem">Aucun produit</p>';return}products.forEach(p=>{const item=document.createElement('div');item.className='product-item';item.innerHTML=`<div class="product-item-image"><img src="${p.image||'https://via.placeholder.com/280x200?text=Image'}" alt="${p.title||p.name||'Produit'}" onerror="this.src='https://via.placeholder.com/280x200?text=No+Image'"></div><div class="product-item-content"><div class="product-item-category">${p.category||''}</div><div class="product-item-title">${p.title||p.name||'Produit'}</div>${p.description?`<div class="product-item-meta">${p.description}</div>`:''}<div class="product-item-footer" style="margin-top:auto"><div class="product-item-price">${(Number(p.price)||0).toLocaleString('fr-FR')} HTG</div><div class="product-item-actions"><button class="btn-danger delete-btn" data-id="${p.id}">üóëÔ∏è</button></div></div></div>`;item.querySelector('.delete-btn').addEventListener('click',async()=>{if(confirm('Supprimer?')){try{await deleteProduct(p.id);await loadProducts();showNotification('‚úì Supprim√©','success')}catch(e){showNotification('‚ùå '+e.message,'error')}}});productsGrid.appendChild(item)})}

    async function loadOrders(){try{orders=await getOrders();renderOrders();updateStats()}catch(err){showNotification('‚ùå '+err.message,'error')}}

    function renderOrders(){const list=document.getElementById('orders-list');list.innerHTML='';if(!orders.length){list.innerHTML='<p style="text-align:center;color:var(--text-muted);padding:2rem">Aucune commande</p>';return}orders.forEach(o=>{const card=document.createElement('div');card.className='order-card';const items=(o.items||[]).map(i=>`‚Ä¢ ${i.title} √ó${i.quantity||1}`).join('<br>');card.innerHTML=`<div class="order-header"><div class="order-id">üõí #${o.id.substring(0,8)}</div><div class="order-status ${o.status}">${'pending'===o.status?'‚è≥ Attente':'completed'===o.status?'‚úÖ Termin√©e':'‚ùå Annul√©e'}</div></div><div class="order-details"><strong>üìß ${o.customer_email||'N/A'}</strong><br>üì± ${o.customer_phone||'N/A'}</div><div class="order-items">${items}</div><div class="order-details">üí∞ ${(o.total||0).toLocaleString('fr-FR')} HTG<br>üïê ${new Date(o.created_at).toLocaleString('fr-FR')}</div><div class="order-actions"><button class="btn-success complete-btn" data-id="${o.id}">‚úÖ</button><button class="btn-danger cancel-btn" data-id="${o.id}">‚ùå</button></div>`;card.querySelector('.complete-btn').addEventListener('click',async()=>{try{await updateOrder(o.id,{status:'completed'});await loadOrders();showNotification('‚úì Termin√©e','success')}catch(e){showNotification('‚ùå '+e.message,'error')}});card.querySelector('.cancel-btn').addEventListener('click',async()=>{try{await updateOrder(o.id,{status:'cancelled'});await loadOrders();showNotification('‚úì Annul√©e','success')}catch(e){showNotification('‚ùå '+e.message,'error')}});list.appendChild(card)})}

    function updateStats(){document.getElementById('stat-products').textContent=products.length;document.getElementById('stat-orders').textContent=orders.length;document.getElementById('stat-pending').textContent=orders.filter(o=>'pending'===o.status).length}

    checkAccess();
  </script>
</body>
</html>
